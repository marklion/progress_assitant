dist: focal
install:
- DEBIAN_FRONTEND=noninteractive sudo apt-get install -y libpython3-dev npm nodejs sqlite3 libsqlite3-dev uuid uuid-dev libcurl4-openssl-dev automake bison flex g++ git libboost-all-dev libevent-dev libssl-dev libtool make pkg-config
- mkdir thrift_dir
- cp depend_docker/thrift-0.14.1.tar.gz ./thrift_dir/
- pushd thrift_dir
- tar xf thrift-0.14.1.tar.gz
- pushd thrift-0.14.1
- ./configure --prefix=/usr --without-ruby --without-java --without-go --without-erlang --without-perl --without-qt5 --without-lua --without-php --without-nodejs --without-php_extension && make -j 8 && sudo make install
- popd
- popd

script: 
- ./build.sh -bf -m build

deploy:
  provider: releases
  skip_cleanup: true
  file: "${TRAVIS_BUILD_DIR}/build/install.sh"
  api_key: ${API_KEY}
  on: 
    tags: true
env:
  global:
   # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
   #   via the "travis encrypt" command using the project repo's public key
   - secure: "KvXKpZSfzfMnmXnH9gtH1KZUfllqEqqKGoYbHRYEFsSuop51fcV5UpNZskpzCB+Im8aXPs3z1YNadAzrPRhpaulmW4GVx1dPreV3BeaEoi2pqXF0gVbCAxTHanBULpnEGlVJw8I3dFmyFA1Ae4+dOtOo4QQ7eGSxzfkK3MrO6v8bHmbR/+XCiLtcsYC/x3yX2DRUC59FtkflLWFun2rOndCDdj4ybOZN1EzHo+6iolWAEvah/vfqU0RsO7v5/DH7kN6zyu+5Kp8cnd5aH+PauZnSdSi8WRXBzNyCRV5MzpQgUTSpjExtXR5F2I45RY3FGnHDObu8Chtz6VYyGpwOUilifr35eLPVzpJUu1uhKWcf/S3x61wEk6dLJIZ+SzCKtxDaZE0tE607bdLH5OT7UBKM7YZdQ6Qx7nZ1BvgAQQQkGNApbi4qDpDnwZmN+DP+5/015A3OVk7uvXhvaG4ddeKdKOvCQj+VneZJCvN2FYrMCF8UP4BCDeLj2tPt/+srx8u3doYznUIeFB5OWxRvGfJpRfXJS7A1cGsfvaHbwLBJxUhlHqOk9wtOUBMp1PnM9UOiVHZnwZ2qjMujcFZiHdFVwsWCLcAGFbooQ6oyezmVFaQ9t1QzM5QzKsb5GqReHg1Pa0YdzHRb8UGS8H4zsOdhRmBIRcck2bwTs8828QQ="

before_install:
  - echo -n | openssl s_client -connect https://scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-

addons:
  coverity_scan:
    project:
      name: "marklion/progress_assitant"
      description: "scan"
    notification_email: marklion@sina.com
    build_command_prepend: "echo run_prepare"
    build_command: "./build.sh -bf -m build -o cov-build"
    branch_pattern: coverity_scan
